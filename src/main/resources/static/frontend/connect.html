<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Graphura – Connect Channels</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.gstatic.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
  <!-- Configuration file -->
  <script src="config.js"></script>

  <style>
    /* ===== SIDEBAR ===== */
    .sidebar-link {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 14px;
      border-radius: 14px;
      font-weight: 500;
      color: #475569;
      transition: all 0.25s ease;
    }

    .sidebar-link:hover {
      background: rgba(249,115,22,0.08);
      color: #f97316;
    }

    .sidebar-active {
      background: rgba(249,115,22,0.15);
      color: #f97316;
      box-shadow: inset 0 0 0 1px rgba(249,115,22,0.25);
      backdrop-filter: blur(12px);
    }

    /* ===== MOBILE SIDEBAR ===== */
    .mobile-menu-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 40px;
      height: 40px;
      border-radius: 10px;
      background: rgba(249, 115, 22, 0.12);
      border: 1px solid rgba(249, 115, 22, 0.18);
      cursor: pointer;
      transition: all 0.3s ease;
      flex-direction: column;
      padding: 0;
    }

    .mobile-menu-btn:hover {
      background: rgba(249, 115, 22, 0.18);
    }

    .mobile-menu-btn span {
      width: 20px;
      height: 2px;
      background: #f97316;
      display: block;
      margin: 3px 0;
      transition: all 0.3s ease;
    }

    .mobile-sidebar-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
      z-index: 30;
    }

    .mobile-sidebar-overlay.open {
      background: rgba(0, 0, 0, 0.4);
      opacity: 1;
      pointer-events: auto;
    }

    .mobile-sidebar {
      position: fixed;
      left: 0;
      top: 0;
      height: 100vh;
      width: 256px;
      background: white;
      border-r: 1px solid rgba(249, 115, 22, 0.12);
      transform: translateX(-100%);
      transition: transform 0.35s cubic-bezier(0.4, 0, 0.2, 1);
      z-index: 40;
      box-shadow: 4px 0 24px rgba(0, 0, 0, 0.12);
      overflow-y: auto;
    }

    .mobile-sidebar.open {
      transform: translateX(0);
    }

    @media (min-width: 1024px) {
      .mobile-menu-btn {
        display: none !important;
      }
      .mobile-sidebar-overlay {
        display: none !important;
      }
      .mobile-sidebar {
        display: none !important;
      }
    }

    /* Make mobile button more visible (unified orange/pink) */
    .mobile-menu-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 38px;
      height: 38px;
      border-radius: 8px;
      background: rgba(249, 115, 22, 0.12);
      border: 1px solid rgba(249, 115, 22, 0.2);
      cursor: pointer;
      transition: all 0.25s ease;
      flex-direction: column;
      padding: 0;
      flex-shrink: 0;
    }

    .mobile-menu-btn:hover {
      background: rgba(249, 115, 22, 0.18);
      border-color: rgba(249, 115, 22, 0.34);
    }

    .mobile-menu-btn span {
      width: 18px;
      height: 2px;
      background: #f97316;
      display: block;
      margin: 2.5px 0;
      transition: all 0.25s ease;
      border-radius: 1px;
    }
    
    /* Top decorative accent */
    .page-accent {
      background: linear-gradient(90deg, rgba(249,115,22,0.06), rgba(99,102,241,0.03));
      border-radius: 14px;
      padding: 18px;
    }

    body { font-family: 'Inter', system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial; }
    .channel-card { transition: transform .32s, box-shadow .32s, border-color .32s; }
    .channel-card:hover{ transform: translateY(-6px); box-shadow: 0 20px 40px rgba(2,6,23,0.12); }
    .platform-icon-wrap{ width:56px; height:56px; border-radius:12px; display:flex; align-items:center; justify-content:center }
    /* Button styles following current UI amber/orange scheme */
    .connect-btn{
      position: relative;
      overflow: hidden;
      background: linear-gradient(135deg, #f97316 0%, #ec4899 100%);
      color: #ffffff;
      border: 1px solid rgba(249,115,22,0.16);
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(249,115,22,0.14);
      transition: transform .16s ease, box-shadow .16s ease, filter .12s ease;
      display:inline-flex; align-items:center; justify-content:center; gap:8px;
      padding-left:0.9rem; padding-right:0.9rem;
    }
    .connect-btn::after{
      content: "";
      position: absolute;
      left: -40%;
      top: -50%;
      width: 120%;
      height: 220%;
      background: linear-gradient(120deg, rgba(255,255,255,0.18) 0%, rgba(255,255,255,0.02) 60%, rgba(255,255,255,0) 100%);
      transform: rotate(20deg);
      transition: all .6s cubic-bezier(.2,.9,.2,1);
      opacity: .9;
      pointer-events: none;
    }
    .connect-btn:hover{ transform: translateY(-4px); box-shadow: 0 20px 44px rgba(249,115,22,0.28); filter: saturate(1.05); }
    .connect-btn:hover::after{ left: 120%; }
    .connect-btn:active{ transform: translateY(-1px) scale(.997); }

    /* Disconnect keeps a neutral surface but uses red text + subtle red accent, while remaining within UI tone */
    .disconnect-btn{
      position: relative;
      overflow: hidden;
      background: linear-gradient(180deg, #ffffff 0%, #fbfbfb 100%);
      color: #b91c1c;
      border: 1px solid rgba(185,28,28,0.08);
      box-shadow: 0 8px 24px rgba(2,6,23,0.04);
      transition: transform .14s ease, box-shadow .14s ease, border-color .14s ease;
    }
    .disconnect-btn:hover{ transform: translateY(-3px); box-shadow: 0 18px 36px rgba(2,6,23,0.08); border-color: rgba(249,115,22,0.14); }
    .disconnect-btn:active{ transform: translateY(0) scale(.997); }
    /* Connected button (creative green) */
    .connected-btn{
      position: relative;
      overflow: hidden;
      background: linear-gradient(90deg,#10b981 0%, #059669 100%);
      color: #ffffff;
      border: 1px solid rgba(6,95,70,0.12);
      box-shadow: 0 12px 36px rgba(6,95,70,0.12);
      transition: transform .16s ease, box-shadow .16s ease, filter .12s ease;
      display:inline-flex; align-items:center; justify-content:center; gap:10px;
      padding-left:0.9rem; padding-right:0.9rem; border-radius:12px; font-weight:700;
    }
    .connected-btn::after{
      content: "";
      position:absolute; left:-30%; top:-30%; width:140%; height:160%; background: radial-gradient(circle at 20% 20%, rgba(255,255,255,0.14), rgba(255,255,255,0) 30%);
      transform: rotate(14deg); transition: all .6s cubic-bezier(.2,.9,.2,1); pointer-events:none;
    }
    .connected-btn:hover{ transform: translateY(-3px); box-shadow: 0 18px 44px rgba(6,95,70,0.14); filter: saturate(1.05); }
  </style>
</head>

<body class="bg-white text-slate-800 min-h-screen">

<script>
  // Redirect admin users to admin-dashboard; prevent admins using non-admin pages
  (function(){
    const authToken = localStorage.getItem('authToken');
    const role = localStorage.getItem('userRole');
    if (!authToken) {
      window.location.href = 'home.html';
      return;
    }
    if (role === 'ADMIN') {
      window.location.href = 'admin-dashboard.html';
      return;
    }
  })();
</script>

<!-- MOBILE SIDEBAR OVERLAY -->
<div id="mobileSidebarOverlay" class="mobile-sidebar-overlay" onclick="closeMobileSidebar()"></div>

<!-- MOBILE SIDEBAR -->
<aside id="mobileSidebar" class="mobile-sidebar">
  <!-- LOGO -->
   <div class="px-4 py-4 border-b flex items-center justify-between">
      <img src="assets/graphuralogo.png" class="h-12" alt="Graphura Logo" />
      <button class="text-gray-500 hover:text-gray-700 text-xl" onclick="closeMobileSidebar()">✕</button>
    </div>

  <!-- NAV -->
  <nav class="px-4 py-6 space-y-1 flex-1">
    <a href="main.html" class="sidebar-link" onclick="closeMobileSidebar()">
      Dashboard
    </a>
    <a href="connect.html" class="sidebar-link sidebar-active" onclick="closeMobileSidebar()">
      Channels
    </a>
    <a href="analysis.html" class="sidebar-link" onclick="closeMobileSidebar()">
      Analytics
    </a>
    <a href="help.html" class="sidebar-link" onclick="closeMobileSidebar()">
      Help & Guide
    </a>
    <a href="f&q.html" class="sidebar-link" onclick="closeMobileSidebar()">
      FAQs
    </a>
  </nav>

  <!-- USER PROFILE -->
  <div class="p-4 border-t relative">
    <button id="mobileSidebarProfileBtn"
      class="w-full flex items-center gap-3 p-3 rounded-full bg-white/80 border border-orange-200/40 shadow-sm hover:shadow-md hover:bg-orange-50/60 hover:border-orange-300/60 transition">
      <div class="w-9 h-9 rounded-full bg-gradient-to-br from-orange-200 to-pink-200 flex items-center justify-center font-bold">
        <img src="assets/user_icon.png" class="w-5 h-5" />
      </div>
      <div class="truncate text-left">
        <p id="mobileSidebarUserName" class="text-sm font-semibold text-slate-800">User</p>
        <p id="mobileSidebarUserEmail" class="text-xs text-slate-600 truncate"></p>
      </div>
    </button>

    <!-- DROPDOWN -->
    <div id="mobileSidebarProfileMenu"
      class="hidden absolute bottom-20 left-4 right-4 bg-white border rounded-xl shadow-xl overflow-hidden z-50">
      <button onclick="window.location.href='home.html'"
        class="w-full px-4 py-3 text-left text-slate-700 hover:bg-slate-50 font-medium border-b">
        Go to Home
      </button>
      <button onclick="logout()"
        class="w-full px-4 py-3 text-left text-red-600 hover:bg-red-50 font-medium">
        Logout
      </button>
    </div>
  </div>
</aside>

<!-- ================= APP LAYOUT ================= -->
<div class="flex min-h-screen">

  <!-- ================= SIDEBAR ================= -->
  <aside class="hidden lg:flex fixed left-0 top-0 h-screen w-64 bg-white border-r border-orange-200/30 flex flex-col justify-between">

    <!-- LOGO -->
    <div class="px-6 py-6 border-b flex items-center justify-center">
      <img src="assets/graphuralogo.png" class="h-16" />
    </div>

    <!-- NAV -->
    <nav class="px-4 py-6 space-y-1 flex-1">

      <a href="main.html" class="sidebar-link">
        Dashboard
      </a>
      <a href="connect.html" class="sidebar-link sidebar-active">
        Channels
      </a>
      <a href="analysis.html" class="sidebar-link">
        Analytics
      </a>
      <a href="help.html" class="sidebar-link">
        Help & Guide
      </a>
      <a href="f&q.html" class="sidebar-link">
        FAQs
      </a>

    </nav>
 <!-- USER PROFILE -->
    <div class="p-4 relative">

      <!-- Sidebar Profile (place LAST in sidebar) -->
<button id="sidebarProfileBtn"
  class="mt-auto w-full flex items-center gap-3
         px-4 py-3
         rounded-full
         bg-white/80 border border-orange-200/40
         hover:bg-orange-50/60 hover:border-orange-300/60
         shadow-sm hover:shadow-md
         transition">

  <!-- Avatar -->
  <div class="w-10 h-10 rounded-full
              bg-gradient-to-br from-orange-200 to-pink-200
              flex items-center justify-center
              shrink-0">
    <img src="assets/user_icon.png" class="w-5 h-5" alt="User" />
  </div>

  <!-- User Info -->
  <div class="min-w-0 text-left">
    <p id="sidebarUserName"
       class="text-sm font-semibold text-slate-800 leading-tight">
      User
    </p>

    <!-- Email: readable, not truncated harshly -->
    <p id="sidebarUserEmail"
       class="text-xs text-slate-600 leading-tight break-all">
      user@email.com
    </p>
  </div>

</button>

      <!-- DROPDOWN -->
      <div id="sidebarProfileMenu"
        class="hidden absolute bottom-20 left-4 right-4 bg-white border rounded-xl shadow-xl overflow-hidden z-50">

        <button onclick="window.location.href='home.html'"
          class="w-full px-4 py-3 text-left text-slate-700 hover:bg-slate-50 font-medium border-b">
          Go to Home
        </button>

        <button onclick="logout()"
          class="w-full px-4 py-3 text-left text-red-600 hover:bg-red-50 font-medium">
          Logout
        </button>

      </div>

    </div>

  </aside>

<!-- ================= MAIN CONTENT ================= -->
<main class="lg:ml-64 flex-1 px-4 lg:px-12 py-6 lg:py-10 bg-slate-50 relative overflow-hidden w-full">
   
    <div class="lg:hidden flex items-center justify-between px-4 py-4 bg-white border-b border-cyan-200/30 width-full fixed top-0 left-0 right-0 z-20">
      <img src="assets/graphuralogo.png" class="h-10" alt="Graphura Logo" />
      <button class="mobile-menu-btn" onclick="openMobileSidebar()" aria-label="Toggle menu">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
  <!-- ===== PAGE HEADER ===== -->
  <header class="flex items-start gap-3 sm:gap-4 mb-6 lg:mb-10 pt-16 lg:pt-0">
    <!-- MOBILE MENU BUTTON -->
   
    
    <div class="flex-1 min-w-0">
      <div class="flex items-center gap-3">
        <svg class="w-8 h-8 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <circle cx="6" cy="12" r="3" stroke-width="2"/>
          <circle cx="18" cy="6" r="3" stroke-width="2"/>
          <circle cx="18" cy="18" r="3" stroke-width="2"/>
            <path d="M8.7 10.5L15.3 7.5
            M8.7 13.5L15.3 16.5" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>

        <h1 class="text-3xl sm:text-4xl lg:text-5xl font-black text-slate-900 tracking-tight">
          Connect Channels
        </h1>
      </div>
      <p class="text-sm sm:text-base text-slate-600 mt-2 font-medium">Connect your social media accounts to schedule and manage posts</p>

      <div class="mt-4 page-accent flex items-center justify-between gap-4">
        <div>
          <p class="text-sm text-slate-600">Total connected</p>
          <p class="text-2xl font-extrabold text-slate-900"><span id="total-active">0</span> <span class="text-sm font-medium text-slate-500">/ 5</span></p>
        </div>
      </div>
    </div>
  </header>

  <!-- ===== CHANNELS GRID ===== -->
  <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-5 lg:gap-6 relative">

    <!-- Facebook -->
    <div class="channel-card relative rounded-2xl overflow-hidden bg-slate-50 border border-slate-200 p-5 lg:p-6">
      <div class="flex items-start justify-between mb-4 gap-3">
        <div class="platform-icon-wrap shadow-sm" style="background:linear-gradient(180deg, rgba(59,130,246,0.08), rgba(59,130,246,0.02));">
          <img src="assets/facebook.png" alt="Facebook" class="w-8 h-8 object-contain">
        </div>
        <span id="facebook-status" class="px-2 lg:px-3 py-1 rounded-lg text-[10px] lg:text-xs font-semibold bg-slate-100 text-slate-700 whitespace-nowrap">
          Disconnected
        </span>
      </div>

      <h3 class="text-base lg:text-lg font-bold text-slate-900 mb-3">Facebook</h3>

      <button id="facebook-btn" onclick="connectChannel('FACEBOOK')" class="w-full py-2.5 px-4 rounded-xl font-bold text-sm connect-btn text-white shadow-md group">
        <span>Connect Now</span>
        <svg class="w-4 h-4 transition-transform group-hover:translate-x-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
        </svg>
      </button>
    </div>


   

    <!-- Twitter/X -->
    <div class="channel-card relative rounded-2xl overflow-hidden bg-slate-50 border border-slate-200 p-5 lg:p-6">
      <div class="flex items-start justify-between mb-4 gap-3">
        <div class="platform-icon-wrap shadow-sm" style="background:linear-gradient(180deg, rgba(30,41,59,0.06), rgba(30,41,59,0.02));">
          <img src="assets/twitter.png" alt="Twitter" class="w-8 h-8 object-contain">
        </div>
        <span id="twitter-status" class="px-2 lg:px-3 py-1 rounded-lg text-[10px] lg:text-xs font-semibold bg-slate-100 text-slate-700 whitespace-nowrap">Disconnected</span>
      </div>

      <h3 class="text-base lg:text-lg font-bold text-slate-900 mb-3">Twitter / X</h3>
      <button id="twitter-btn" onclick="connectChannel('TWITTER')" class="w-full py-2.5 px-4 rounded-xl font-bold text-sm connect-btn text-white shadow-md group">
        <span>Connect Now</span>
        <svg class="w-4 h-4 transition-transform group-hover:translate-x-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
        </svg>
      </button>
    </div>

    <!-- YouTube -->
    <div class="channel-card relative rounded-2xl overflow-hidden bg-slate-50 border border-slate-200 p-5 lg:p-6">
      <div class="flex items-start justify-between mb-4 gap-3">
        <div class="platform-icon-wrap shadow-sm" style="background:linear-gradient(180deg, rgba(239,68,68,0.06), rgba(239,68,68,0.02));">
          <img src="assets/youtube.png" alt="YouTube" class="w-8 h-8 object-contain">
        </div>
        <span id="youtube-status" class="px-2 lg:px-3 py-1 rounded-lg text-[10px] lg:text-xs font-semibold bg-slate-100 text-slate-700 whitespace-nowrap">Disconnected</span>
      </div>

      <h3 class="text-base lg:text-lg font-bold text-slate-900 mb-3">YouTube</h3>
      <button id="youtube-btn" onclick="connectChannel('YOUTUBE')" class="w-full py-2.5 px-4 rounded-xl font-bold text-sm connect-btn text-white shadow-md group">
        <span>Connect Now</span>
        <svg class="w-4 h-4 transition-transform group-hover:translate-x-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
        </svg>
      </button>
    </div>
    <!-- LinkedIn -->
    <div class="channel-card relative rounded-2xl overflow-hidden bg-slate-50 border border-slate-200 p-5 lg:p-6">
      <div class="flex items-start justify-between mb-4 gap-3">
        <div class="platform-icon-wrap shadow-sm" style="background:linear-gradient(180deg, rgba(99,102,241,0.06), rgba(99,102,241,0.02));">
          <img src="assets/linkedin.png" alt="LinkedIn" class="w-8 h-8 object-contain">
        </div>
        <span id="linkedin-status" class="px-2 lg:px-3 py-1 rounded-lg text-[10px] lg:text-xs font-semibold bg-slate-100 text-slate-700 whitespace-nowrap">Disconnected</span>
      </div>

      <h3 class="text-base lg:text-lg font-bold text-slate-900 mb-3">LinkedIn</h3>
      <button id="linkedin-btn" onclick="connectChannel('LINKEDIN')" class="w-full py-2.5 px-4 rounded-xl font-bold text-sm connect-btn text-white shadow-md group">
        <span>Connect Now</span>
        <svg class="w-4 h-4 transition-transform group-hover:translate-x-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
        </svg>
      </button>
    </div>

    <!-- Pinterest -->
    <div class="channel-card relative rounded-2xl overflow-hidden bg-slate-50 border border-slate-200 p-5 lg:p-6">
      <div class="flex items-start justify-between mb-4 gap-3">
        <div class="platform-icon-wrap shadow-sm" style="background:linear-gradient(180deg, rgba(239,68,68,0.06), rgba(239,68,68,0.02));">
          <img src="assets/pintrest.png" alt="Pinterest" class="w-8 h-8 object-contain">
        </div>
        <span id="pinterest-status" class="px-2 lg:px-3 py-1 rounded-lg text-[10px] lg:text-xs font-semibold bg-slate-100 text-slate-700 whitespace-nowrap">Disconnected</span>
      </div>

      <h3 class="text-base lg:text-lg font-bold text-slate-900 mb-3">Pinterest</h3>
      <button id="pinterest-btn" onclick="connectChannel('PINTEREST')" class="w-full py-2.5 px-4 rounded-xl font-bold text-sm connect-btn text-white shadow-md group">
        <span>Connect Now</span>
        <svg class="w-4 h-4 transition-transform group-hover:translate-x-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
        </svg>
      </button>
    </div>

  </div>

</main>

</div>

<!-- Notification root for toast-style messages -->
<div id="notification-root" style="position:fixed;top:1rem;right:1rem;z-index:9999;pointer-events:auto"></div>

<script src="component/sidebar.js"></script>
<script src="main.js"></script>
<script src="confirm.js"></script>

<script>
  // Sidebar profile dropdown
  const sidebarProfileBtn = document.getElementById("sidebarProfileBtn");
  const sidebarProfileMenu = document.getElementById("sidebarProfileMenu");

  sidebarProfileBtn.addEventListener("click", e => {
    e.stopPropagation();
    sidebarProfileMenu.classList.toggle("hidden");
  });

  document.addEventListener("click", () => {
    sidebarProfileMenu.classList.add("hidden");
  });

  async function logout() {
    let ok;
    if (typeof showConfirm === 'function') {
      ok = await showConfirm('Are you sure you want to logout?');
    } else {
      ok = confirm('Are you sure you want to logout?');
    }
    if (ok) {
      localStorage.clear();
      window.location.href = "home.html";
    }
  }

  window.onload = () => {
    const token = localStorage.getItem("authToken");
    if (!token) window.location.href = "home.html";

    const userEmail = localStorage.getItem("userEmail") || "";
    const userName = localStorage.getItem("userName") || "User";

    // Update desktop sidebar
    document.getElementById("sidebarUserEmail").textContent = userEmail;
    document.getElementById("sidebarUserName").textContent = userName;

    // Update mobile sidebar
    document.getElementById("mobileSidebarUserEmail").textContent = userEmail;
    document.getElementById("mobileSidebarUserName").textContent = userName;

    // Load connected channels status
    loadChannelStatus();
  };

  //updated loadChannelStatus.........
  async function loadChannelStatus() {
    const token = localStorage.getItem("authToken");
    if (!token) {
        console.warn("No auth token, skipping status load");
        return;
    }

    try {
        // Fetch from the correct endpoint
        const response = await fetch(API_ENDPOINTS.SOCIAL.STATUS, {
            method: 'GET',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        });

        if (response.ok) {
          const data = await response.json();

          // Backend expected shape: { connections: { FACEBOOK: true, ... }, activeCount: 5 }
          console.log("Social Status:", data);

          // Update UI for each platform found in the map
          if (data.connections && typeof data.connections === 'object') {
            Object.keys(data.connections).forEach(platform => {
              const isConnected = !!data.connections[platform];
              updateChannelUI(platform, isConnected);
            });
          }

          // Compute connected count: prefer returned activeCount, otherwise count truthy entries in connections
          let activeCount = typeof data.activeCount !== 'undefined' ? Number(data.activeCount) : null;
          if (activeCount === null) {
            if (data.connections && typeof data.connections === 'object') {
              activeCount = Object.values(data.connections).filter(Boolean).length;
            } else {
              activeCount = 0;
            }
          }

          const totalEl = document.getElementById('total-active');
          if (totalEl) totalEl.innerText = activeCount;

          // Persist the active platforms count so other pages can read it quickly
          try {
            localStorage.setItem('activePlatformsCount', String(activeCount));
            console.log('connect.html: persisted activePlatformsCount =', String(activeCount));
          } catch (e) {
            console.warn('Failed to persist activePlatformsCount to localStorage', e);
          }

        } else {
            console.error("Failed to fetch status");
        }
    } catch (error) {
        console.error('Error loading channel status:', error);
    }
  }


  //UI Updator......
  function updateChannelUI(platform, isConnected) {
    // Normalize platform name to lowercase for IDs (FACEBOOK -> facebook)
    const lowerPlatform = platform.toLowerCase();
    
    // Get Elements
    const statusLabel = document.getElementById(`${lowerPlatform}-status`);
    const actionBtn = document.getElementById(`${lowerPlatform}-btn`);

    // Safety check: if element doesn't exist in HTML, skip it
    if (!statusLabel || !actionBtn) return;

    if (isConnected) {
        // ✅ CONNECTED STATE
        statusLabel.textContent = "Connected";
        statusLabel.className = "px-2 lg:px-3 py-1 rounded-lg text-[10px] lg:text-xs font-semibold bg-green-100 text-green-700 whitespace-nowrap";

        // Connected creative button (green) — clicking will prompt disconnect
        actionBtn.innerHTML = `<span class="flex items-center gap-2"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden><path d="M20 6L9 17l-5-5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg> Connected</span>`;
        actionBtn.className = "w-full py-2 lg:py-2.5 px-3 lg:px-4 rounded-xl connected-btn text-white shadow-sm group";

        // Clicking still disconnects (confirmation + UI feedback)
        actionBtn.onclick = async () => {
          let ok;
          if (typeof showConfirm === 'function') {
            ok = await showConfirm(`Disconnect ${platform}?`);
          } else {
            ok = window.confirm(`Disconnect ${platform}?`);
          }
          if (!ok) return;
          try {
            actionBtn.disabled = true;
            const prev = actionBtn.innerHTML;
            actionBtn.innerHTML = `<span class="flex items-center gap-2">Working...</span>`;
            const ok2 = await disconnectChannel(platform);
            if (!ok2) {
              showNotification('error', 'Failed to disconnect.');
            }
          } finally {
            actionBtn.disabled = false;
            // refresh will update UI from server state
          }
        };

    } else {
        // ❌ DISCONNECTED STATE
        statusLabel.textContent = "Disconnected";
        // Reset specific badge colors based on platform (Generic approach here for simplicity, or revert to original classes)
        statusLabel.className = "px-2 lg:px-3 py-1 rounded-lg text-[10px] lg:text-xs font-semibold bg-slate-100 text-slate-700 whitespace-nowrap";

        actionBtn.innerHTML = `<span>Connect Now</span><svg class="w-4 h-4 transition-transform group-hover:translate-x-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>`;
        // Use centralized connect button style (amber/orange scheme)
        actionBtn.className = "w-full py-2 lg:py-2.5 px-3 lg:px-4 rounded-xl font-semibold text-xs lg:text-sm connect-btn text-white shadow-sm group";
        
        // Bind click to Connect function
        actionBtn.onclick = () => connectChannel(platform);
    }
  }

  // 3. Connect Function (Triggered by button)
  async function connectChannel(platform) {
    const token = localStorage.getItem("authToken");
    
    try {
        // 1. Ask Backend for the Google/Facebook Login URL
        const response = await fetch(`https://social-media-handler-backend.onrender.com/api/channels/auth-url?platform=${platform}`, {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (response.ok) {
            const data = await response.json();
            
            // 2. Redirect the user to that URL
            window.location.href = data.url; 
        } else {
          showNotification('error', 'Could not initialize connection.');
        }
    } catch (error) {
        console.error("Error starting oauth:", error);
    }
}
  // 4. Disconnect Function (Triggered by button)
    async function disconnectChannel(platform) {
    const token = localStorage.getItem("authToken");
    if (!token) return false;

    try {
      const response = await fetch(`${API_ENDPOINTS.SOCIAL.DISCONNECT}?platform=${platform}`, {
        method: 'POST',
        headers: { 'Authorization': `Bearer ${token}` }
      });

      if (response.ok) {
        // Refresh UI from server
        await loadChannelStatus();
        return true;
      } else {
        console.error('Disconnect failed', response.status);
        return false;
      }
    } catch (error) {
      console.error("Disconnect error:", error);
      return false;
    }
    }
  




  // Mobile Sidebar Functions
  function openMobileSidebar() {
    const mobileSidebar = document.getElementById('mobileSidebar');
    const overlay = document.getElementById('mobileSidebarOverlay');
    mobileSidebar.classList.add('open');
    overlay.classList.add('open');
  }

  function closeMobileSidebar() {
    const mobileSidebar = document.getElementById('mobileSidebar');
    const overlay = document.getElementById('mobileSidebarOverlay');
    mobileSidebar.classList.remove('open');
    overlay.classList.remove('open');
  }

  // Mobile Sidebar Profile Menu
  document.addEventListener('DOMContentLoaded', function() {
    const mobileSidebarProfileBtn = document.getElementById('mobileSidebarProfileBtn');
    const mobileSidebarProfileMenu = document.getElementById('mobileSidebarProfileMenu');

    if (mobileSidebarProfileBtn && mobileSidebarProfileMenu) {
      mobileSidebarProfileBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        mobileSidebarProfileMenu.classList.toggle('hidden');
      });

      document.addEventListener('click', (e) => {
        if (!mobileSidebarProfileBtn.contains(e.target) && !mobileSidebarProfileMenu.contains(e.target)) {
          mobileSidebarProfileMenu.classList.add('hidden');
        }
      });
    }

    const urlParams = new URLSearchParams(window.location.search);
    const status = urlParams.get('status');
    
    if (status === 'success') {
      showNotification('success', '✅ Connected successfully!');
      // Clean URL
      window.history.replaceState({}, document.title, window.location.pathname);
    } else if (status === 'error') {
      showNotification('error', '❌ Connection failed.');
    }
    
    loadChannelStatus(); // Refresh grid
  });
</script>
</body>
</script>

<script>
  // Notification utility (copied from main.html)
  function _injectNotificationStyles() {
    if (document.getElementById('notif-styles')) return;
    const css = `
    #notification-root { display:flex; flex-direction:column; gap:10px; pointer-events:auto }
    .notif-card{min-width:280px;max-width:360px;padding:14px 16px;border-radius:12px;box-shadow:0 10px 30px rgba(2,6,23,0.08);display:flex;align-items:flex-start;gap:12px;border:1px solid rgba(2,6,23,0.04);font-family:Inter,system-ui,Arial}
    .notif-card strong{display:block;font-weight:700;color:#0f172a}
    .notif-success{background:linear-gradient(180deg,#ecfdf5,#f0fdf4);border-color:rgba(16,185,129,0.08);}
    .notif-error{background:linear-gradient(180deg,#fff1f0,#fff7f5);border-color:rgba(239,68,68,0.06);}
    .notif-icon{width:36px;height:36px;border-radius:10px;display:grid;place-items:center;flex-shrink:0}
    .notif-success .notif-icon{background:linear-gradient(90deg,#10b981,#059669);color:#fff}
    .notif-error .notif-icon{background:linear-gradient(90deg,#fb7185,#f97316);color:#fff}
    .notif-body{flex:1;color:#0f172a;font-size:14px}
    .notif-close{margin-left:8px;background:transparent;border:none;color:rgba(15,23,42,0.6);cursor:pointer;padding:6px;border-radius:8px;transition:background .15s ease,color .15s ease,transform .15s ease}
    .notif-close:hover{background:rgba(15,23,42,0.08);color:rgba(15,23,42,0.9);transform:translateY(-1px)}
    .notif-enter{animation:notifIn .28s cubic-bezier(.2,.9,.2,1)}
    .notif-leave{animation:notifOut .28s ease forwards}
    @keyframes notifIn{from{transform:translateY(-8px);opacity:0}to{transform:translateY(0);opacity:1}}
    @keyframes notifOut{to{transform:translateY(-12px);opacity:0;height:0;margin:0;padding:0}}
    `;
    const s = document.createElement('style'); s.id = 'notif-styles'; s.innerHTML = css; document.head.appendChild(s);
  }

  function showNotification(type, message, timeout = 4500) {
    _injectNotificationStyles();
    const root = document.getElementById('notification-root');
    if (!root) return alert(message);

    const card = document.createElement('div');
    card.className = 'notif-card notif-' + (type === 'error' ? 'error' : 'success') + ' notif-enter';

    const icon = document.createElement('div'); icon.className = 'notif-icon';
    icon.innerHTML = type === 'error' ? '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 9v4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M12 17h.01" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M10.29 3.86L1.82 18.35A2 2 0 0 0 3.6 21h16.8a2 2 0 0 0 1.78-2.65L13.71 3.86a2 2 0 0 0-3.42 0z" stroke="none" fill="currentColor"/></svg>' : '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M20 6L9 17l-5-5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>';

    const body = document.createElement('div'); body.className = 'notif-body';
    body.innerHTML = `<div>${message}</div>`;

    const closeBtn = document.createElement('button'); closeBtn.className = 'notif-close'; closeBtn.innerHTML = '&#10005;';
    closeBtn.onclick = () => { card.classList.add('notif-leave'); setTimeout(() => card.remove(), 300); };

    card.appendChild(icon); card.appendChild(body); card.appendChild(closeBtn);
    root.prepend(card);

    const t = setTimeout(() => { if (card.parentElement) { card.classList.add('notif-leave'); setTimeout(() => card.remove(), 300); } }, timeout);

    return { element: card, close: () => { clearTimeout(t); if (card.parentElement) { card.remove(); } } };
  }
</script>

</body>
</html>
